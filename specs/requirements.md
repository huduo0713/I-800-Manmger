# I-800 边缘设备算法管理系统 - 需求规格说明书

> **项目名称**: I-800 Algorithm Management System
> **创建日期**: 2025-09-15
> **当前版本**: v2.5.0
> **最后更新**: 2025-10-09
> **维护人员**: Development Team

## 📋 文档修订历史

| 版本 | 日期 | 修订内容 | 修订人 |
|------|------|---------|--------|
| v2.5.0 | 2025-10-09 | 增强MQTT回复日志和算法文件夹管理 | Team |
| v2.4.0 | 2025-09-26 | OPC UA集成与协议统一化 | Team |
| v2.3.0 | 2025-09-25 | 智能设备注册系统 | Team |
| v2.2.0 | 2025-09-24 | MQTT可靠性增强 | Team |
| v2.1.0 | 2025-09-23 | 企业级算法管理 | Team |
| v2.0.0 | 2025-09-20 | GoFrame架构重构 | Team |
| v1.0.0 | 2025-09-15 | 初始版本 | Team |

---

## 1. 项目概述

### 1.1 项目背景
I-800是一款边缘计算设备，需要实现云端与边缘设备之间的算法分发、管理和执行。系统需要支持通过MQTT协议进行云端算法下发、本地文件管理、算法生命周期控制等功能。

### 1.2 项目目标
- 🎯 实现基于MQTT协议的云端算法下发与管理
- 🎯 提供完整的算法生命周期管理（下载、安装、启停、删除、查询）
- 🎯 保证文件传输的完整性和可靠性（MD5校验）
- 🎯 支持跨平台部署（Windows开发、Linux生产环境）
- 🎯 提供HTTP RESTful API用于设备状态查询和管理
- 🎯 实现智能网络检测和设备自动注册
- 🎯 保证MQTT通信的生产级可靠性和稳定性

### 1.3 系统定位
- **设备端**: 边缘计算设备（I-800）
- **用户端**: 云端管理平台
- **角色**: 边缘设备算法管理代理（Edge Device Agent）

---

## 2. 功能需求

### 2.1 核心功能需求

#### FR-001: MQTT算法下发管理 【优先级：P0】

**需求描述**:
系统必须支持通过MQTT协议接收云端下发的算法包，并完成自动下载、校验、解压和安装。

**功能点**:
- 📥 **算法下发** (algorithm.add)
  - 接收云端下发的算法信息（算法ID、版本、下载URL、MD5）
  - 自动下载算法包到指定目录
  - 实时MD5校验确保文件完整性
  - 支持ZIP格式自动解压
  - 支持复合唯一性校验（算法ID + 版本ID）
  - 返回操作结果（成功/失败/错误码）

- 🗑️ **算法删除** (algorithm.delete)
  - 根据算法ID删除指定算法及其所有版本
  - 删除本地文件和数据库记录
  - 特殊协议：算法不存在时返回code=0并警告提示
  - 返回操作结果

- 📊 **算法查询** (algorithm.show)
  - 查询所有已安装算法的信息
  - 返回算法名称、ID、版本、运行状态
  - 支持空列表返回

- ⚙️ **算法启停** (algorithm.config)
  - 根据算法ID控制算法运行状态
  - 修改算法配置文件(config.yaml)中的runStatus字段
  - 支持启动（runStatus=1）和停止（runStatus=0）
  - 返回操作结果

**验收标准**:
- ✅ 所有MQTT操作必须有完整的reply消息（包含code、message字段）
- ✅ 成功操作统一返回message="success"
- ✅ 算法文件夹路径自适应（Windows: ./runtime/algorithm, Linux: /usr/runtime/algorithm）
- ✅ MQTT服务启动时自动检查并创建算法文件夹
- ✅ 所有回复消息包含完整字段（cmdId、version、method、timestamp、code、message、data）

---

#### FR-002: 文件完整性校验 【优先级：P0】

**需求描述**:
确保下载的算法文件完整无损，防止因网络问题导致的文件损坏。

**功能点**:
- 🔐 MD5实时校验：下载完成后立即进行MD5校验
- 🔐 版本唯一性校验：数据库复合唯一约束（algorithm_id + algorithm_version_id）
- 🔐 文件结构校验：ZIP解压后验证目录结构
- 🔐 重复下载防护：相同算法+版本自动拒绝

**验收标准**:
- ✅ MD5不匹配时必须删除文件并返回错误
- ✅ 重复版本下载返回错误码1007（版本已存在）
- ✅ 校验失败日志必须包含详细错误信息

---

#### FR-003: 智能网络检测与设备注册 【优先级：P0】

**需求描述**:
系统启动时自动检测可用网络接口，生成唯一设备ID，并向云端注册设备信息。

**功能点**:
- 🌐 **网络接口检测**
  - 支持三种检测模式：auto（自动）、config（配置优先）、manual（手动）
  - 自动过滤虚拟网卡（VMware、VirtualBox、Hyper-V等）
  - 连通性验证（Ping测试）
  - 获取网卡MAC地址、IP地址、名称

- 🏷️ **动态设备ID生成**
  - 基于MAC地址生成唯一设备ID
  - ClientID格式：edge-{MAC地址}
  - 避免配置冲突

- 📝 **自动设备注册**
  - MQTT连接成功后自动发送注册消息
  - Topic: `/sys/i800/{deviceId}/event/register`
  - 上报信息：IP、MAC、Runtime状态、OPC UA端口
  - 支持Runtime进程状态检测

**验收标准**:
- ✅ 网络检测失败时使用默认配置继续启动（不阻塞主流程）
- ✅ 首次连接和重连正确区分
- ✅ 设备注册消息字段完整（data字段包含所有必需信息）

---

#### FR-004: MQTT连接可靠性保障 【优先级：P0】

**需求描述**:
确保MQTT连接的生产级可靠性，支持异步启动、自动重连、订阅状态追踪。

**功能点**:
- 🔄 **异步非阻塞启动**
  - MQTT服务异步启动，不阻塞HTTP服务等其他功能
  - 连接失败不影响设备基本功能
  - 支持启动后自动重试连接

- 🔄 **双状态订阅管理**
  - subscriptions：跟踪当前连接的订阅状态
  - savedSubscriptions：保存的订阅记录（用于重连恢复）
  - 重连时自动恢复所有订阅
  - 防止"假订阅"现象

- 🔄 **智能健康检查**
  - 30秒间隔状态检测
  - 自动识别连接断开
  - 触发自动重连机制

- 🔄 **详细日志记录**
  - 连接状态变化日志
  - 订阅/取消订阅日志
  - 重连过程日志
  - MQTT回复消息详细日志（包含所有字段和完整JSON）

**验收标准**:
- ✅ 启动流程不阻塞，HTTP服务正常启动
- ✅ MQTT连接失败时自动重试，不影响其他功能
- ✅ 重连后订阅状态完全恢复
- ✅ 健康检查机制稳定运行

---

#### FR-005: HTTP RESTful API 【优先级：P1】

**需求描述**:
提供HTTP API用于设备状态查询、用户管理等功能。

**功能点**:
- 📡 **用户管理API**
  - GET /api/v1/user/list - 获取用户列表
  - GET /api/v1/user/:id - 获取单个用户
  - POST /api/v1/user - 创建用户
  - PUT /api/v1/user/:id - 更新用户
  - DELETE /api/v1/user/:id - 删除用户

- 📡 **算法查询API**（预留）
  - 支持通过HTTP查询算法列表
  - 支持算法详情查询

**验收标准**:
- ✅ 所有API返回标准JSON格式
- ✅ 支持Swagger文档自动生成
- ✅ 错误处理规范统一

---

#### FR-006: 数据持久化 【优先级：P0】

**需求描述**:
使用SQLite数据库存储算法信息，支持数据查询和管理。

**功能点**:
- 💾 **算法信息存储**
  - 算法ID、名称、版本、下载URL、MD5
  - 文件大小、最后修改时间
  - 复合唯一约束（algorithm_id + algorithm_version_id）

- 💾 **数据完整性保障**
  - 触发器自动更新时间戳
  - 外键约束（如需要）
  - 事务支持

**验收标准**:
- ✅ 数据库操作支持事务
- ✅ 复合唯一约束生效
- ✅ 支持并发操作

---

#### FR-007: OPC UA集成 【优先级：P1】

**需求描述**:
集成OPC UA协议支持，提供设备数据访问接口。

**功能点**:
- 🔌 **OPC UA服务器配置**
  - 支持配置OPC UA服务器端口（默认4840）
  - 启动时显示OPC UA服务地址

- 🔌 **设备注册增强**
  - 注册消息自动包含opcuaServerPort字段
  - 便于平台统一管理OPC UA连接

**验收标准**:
- ✅ OPC UA端口可配置
- ✅ 设备注册消息包含OPC UA信息
- ✅ 启动日志显示OPC UA地址

---

### 2.2 非功能需求

#### NFR-001: 性能需求
- ⚡ 算法下载速度：根据网络带宽，支持大文件（>100MB）下载
- ⚡ MQTT消息响应时间：<500ms
- ⚡ API响应时间：<200ms（P95）
- ⚡ 数据库查询时间：<50ms

#### NFR-002: 可靠性需求
- 🛡️ MQTT连接稳定性：支持自动重连，故障恢复时间<30秒
- 🛡️ 文件完整性保证：MD5校验通过率100%
- 🛡️ 数据持久化：SQLite文件定期备份

#### NFR-003: 可维护性需求
- 🔧 日志系统：滚动文件日志，20MB自动切分
- 🔧 错误码规范：统一错误码定义（0-成功，1xxx-业务错误）
- 🔧 配置管理：YAML配置文件，支持热更新（部分配置）

#### NFR-004: 兼容性需求
- 🖥️ 操作系统：Windows 10+、Linux (Ubuntu 18.04+, CentOS 7+)
- 🖥️ 架构支持：x86_64、ARM64
- 🖥️ Go版本：1.23.0+

#### NFR-005: 安全性需求
- 🔐 MQTT认证：支持用户名/密码认证（可选）
- 🔐 文件校验：强制MD5校验
- 🔐 API安全：支持Token认证（预留）

---

## 3. 业务规则

### BR-001: 算法版本管理规则
- 同一算法ID可以有多个版本
- 算法ID + 版本ID必须唯一
- 删除算法时删除所有版本

### BR-002: 文件路径规则
- Windows开发环境：`./runtime/algorithm/{algorithmId}/{algorithmVersionId}/`
- Linux生产环境：`/usr/runtime/algorithm/{algorithmId}/{algorithmVersionId}/`
- 启动时自动创建算法根目录

### BR-003: MQTT消息规则
- Topic格式：`/sys/i800/{deviceId}/request` (云端→设备)
- Topic格式：`/sys/i800/{deviceId}/reply` (设备→云端)
- 所有reply消息必须包含：cmdId、version、method、timestamp、code、message、data
- 成功消息统一：message="success", code=0
- 删除特殊规则：算法不存在时返回code=0，message警告提示

### BR-004: 错误码定义
```
0     - 成功
1000  - 未知错误
1001  - 参数错误
1002  - JSON解析失败
1003  - 文件下载失败
1004  - MD5校验失败
1005  - 无效参数
1006  - 算法不存在
1007  - 算法版本已存在
1008  - 数据库操作失败
1009  - 文件操作失败
1010  - ZIP解压失败
```

### BR-005: 设备注册规则
- 首次连接时发送注册消息
- 重连时不重复发送注册消息
- 注册消息Topic：`/sys/i800/{deviceId}/event/register`
- 注册消息必须包含：IP、MAC、runtimeStatus、opcuaServerPort

---

## 4. 约束条件

### 4.1 技术约束
- 必须使用GoFrame v2.9.3框架
- 必须使用Eclipse Paho MQTT客户端
- 必须使用SQLite3数据库
- Go版本：1.23.0 或 1.24.4

### 4.2 业务约束
- 算法文件大小限制：单个文件<500MB
- 并发下载限制：最多3个并发下载任务
- 数据库文件大小：建议<100MB

### 4.3 环境约束
- 生产环境：Linux（SysV init脚本部署）
- 开发环境：Windows（直接运行或Docker）
- 网络要求：稳定的MQTT Broker连接

---

## 5. 用户场景

### UC-001: 云端下发算法
**角色**: 云端管理员
**前置条件**: MQTT连接正常
**主流程**:
1. 云端发送算法下发请求到Topic：`/sys/i800/{deviceId}/request`
2. 设备接收请求，解析JSON参数
3. 设备下载算法文件（显示进度）
4. 设备进行MD5校验
5. 设备解压ZIP文件（如果是ZIP格式）
6. 设备保存算法信息到数据库
7. 设备发送成功回复到Topic：`/sys/i800/{deviceId}/reply`

**异常流程**:
- MD5校验失败：返回错误码1004，删除下载文件
- 版本已存在：返回错误码1007，不覆盖现有版本
- 下载失败：返回错误码1003，清理临时文件

---

### UC-002: 删除算法
**角色**: 云端管理员
**前置条件**: 算法已安装
**主流程**:
1. 云端发送删除请求
2. 设备查询算法是否存在
3. 设备删除本地文件和数据库记录
4. 设备返回成功回复（code=0, message="success"）

**异常流程**:
- 算法不存在：返回code=0，message警告提示（特殊协议要求）

---

### UC-003: 设备启动自注册
**角色**: 边缘设备
**前置条件**: 网络连接正常
**主流程**:
1. 设备启动，检测网络接口
2. 生成设备ID（基于MAC地址）
3. 连接MQTT Broker
4. 发送设备注册消息（包含IP、MAC、Runtime状态、OPC UA端口）
5. 开始监听云端指令

**异常流程**:
- 网络检测失败：使用默认配置继续启动
- MQTT连接失败：异步重试，不阻塞主流程

---

## 6. 质量保证

### 6.1 测试策略
- ✅ 单元测试：覆盖率>80%
- ✅ 集成测试：MQTT消息流测试、API测试
- ✅ 压力测试：并发下载、大文件测试
- ✅ 兼容性测试：Windows/Linux跨平台测试

### 6.2 监控指标
- 📊 MQTT连接状态
- 📊 算法下载成功率
- 📊 MD5校验通过率
- 📊 API响应时间
- 📊 日志文件大小

---

## 7. 未来规划

### 7.1 短期规划（v2.x）
- 🔜 增强算法运行状态监控
- 🔜 支持算法配置动态更新
- 🔜 增加算法执行日志查询API

### 7.2 长期规划（v3.x）
- 🔮 支持多协议（CoAP、WebSocket）
- 🔮 云边协同计算
- 🔮 AI模型推理集成
- 🔮 图形化管理界面

---

## 8. 附录

### 8.1 参考文档
- GoFrame官方文档：https://goframe.org
- Eclipse Paho MQTT：https://github.com/eclipse/paho.mqtt.golang
- MQTT协议规范：https://mqtt.org

### 8.2 术语表
| 术语 | 定义 |
|------|------|
| MQTT | Message Queuing Telemetry Transport，轻量级消息传输协议 |
| MD5 | 消息摘要算法，用于文件完整性校验 |
| OPC UA | Open Platform Communications Unified Architecture，工业通信协议 |
| SQLite | 轻量级嵌入式数据库 |
| GoFrame | Go语言企业级Web框架 |
| Edge Device | 边缘计算设备 |

---

**文档结束**
